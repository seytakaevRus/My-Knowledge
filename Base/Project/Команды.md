---
refs:
  - https://learn.microsoft.com/ru-ru/sql/linux/tutorial-restore-backup-in-sql-server-container?view=sql-server-ver16&tabs=cli
  - https://dev.to/sandord/restoring-a-sql-server-backup-in-a-windows-docker-container-1em
  - https://web.archive.org/web/20201212000307/https://danielssilva.dev/2019-09-09-MODIFY-FILE-encountered-operating-system-error-31(A-device-attached-to-the-system-is-not-functioning.)-while-attempting-to-expand-the-physical-file/
---


## MSSQL + Docker +  MAC

Поднять MSSQL в Докере:

```bash
sudo docker run -e "ACCEPT_EULA=Y" -e MSSQL_PID="Developer" -e "MSSQL_SA_PASSWORD=nvu4Dy2xbXKk3zP7qC8Wps" --name "mssql-server" -v sql1data:/var/opt/mssql \
   -p 1433:1433 -h mssql \
   -d mcr.microsoft.com/mssql/server:2022-latest
```

Открыть терминал контейнера и там выполнить эту команду, чтобы попасть в терминал к СУБД:

```bash
/opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P "nvu4Dy2xbXKk3zP7qC8Wps"
```

Создать папку внутри контейнера `mssql-server`.

```bash
docker exec -it mssql-server mkdir /var/opt/mssql/backup
```

Скопировать файл `.bak` в контейнер `mssql-server`.

```bash
docker cp /Users/user/Downloads/SW_Central_RU01_test_19052023.bak mssql-server:/var/opt/mssql/backup/
```

Выяснить логические имена файлов и пути внутри `.bak` файла.

```bash
sudo docker exec -it mssql-server /opt/mssql-tools/bin/sqlcmd -S localhost \
   -U SA -P "nvu4Dy2xbXKk3zP7qC8Wps" \
   -Q 'RESTORE FILELISTONLY FROM DISK = "/var/opt/mssql/backup/SW_Central_RU01_test_19052023.bak"' \
   | tr -s ' ' | cut -d ' ' -f 1-2
```

Восстановить `.bak`, использую перечисленные имена файлов

```bash
sudo docker exec -it mssql-server /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P "nvu4Dy2xbXKk3zP7qC8Wps" -Q "RESTORE DATABASE SW_SCBD_DATABASE FROM DISK = '/var/opt/mssql/backup/SW_Central_RU01_test_19052023.bak' WITH MOVE 'SW_SCBD' TO '/var/opt/mssql/data/SW_Central_RU01_test.mdf', MOVE 'SW_SCBD_log' TO '/var/opt/mssql/data/SW_Central_RU01_test_1.ldf'"
```